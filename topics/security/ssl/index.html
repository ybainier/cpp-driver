<!DOCTYPE html>
<html lang="en">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="DataStax C++ Driver for Apache Cassandra Documentation">
    <meta name="author" content="DataStax">

    <title>DataStax C++ Driver for Apache Cassandra - SSL</title>

    <link rel="icon" href="../../../favicons/favicon.ico">
    <link rel="apple-touch-icon" href="../../../favicons/favicon.png">
    <link href="../../../css/style.css" rel="stylesheet">
    <link href="../../../css/pygments.css" rel="stylesheet">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body ng-app="docs">
    <header class="navbar navbar-default navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../../">Cassandra C/C++ Driver</a>
        </div>
        <div class="collapse navbar-collapse" ng-controller="search">
          <ul class="nav navbar-nav">
            <li><a href="../../../">Introduction</a></li>
            <li class="active"><a href="../../">Topics</a></li>
            <li><a href="../../../api/">API docs</a></li>
          </ul>
          <form class="navbar-form form-search navbar-right dropdown visible-lg-block" ng-class="{open: hasResults}" role="search" ng-submit="submit()">
            <div class="form-group has-feedback">
              <input type="search" class="form-control input-sm mousetrap" placeholder="Search..." ng-model="q" ng-change="search()" data-toggle="dropdown" data-hotkey="{down: moveDown, up: moveUp, esc: reset}" data-search>
              <button type="button" class="close form-control-feedback input-sm hidden" ng-click="reset()" ng-class="{hidden: !hasResults}"><span aria-hidden="true">×</span><span class="sr-only">Reset</span></button>
            </div>
            <ul class="dropdown-menu" role="menu">
              <li ng-repeat="result in results" ng-class="{'bg-warning': $index == current}"><a ng-href="{{basePath}}{{result.path}}"><span ng-bind-html="summary(result)"></span></a></li>
            </ul>
          </form>
        </div>
      </div>
    </header>

    <div class="container" id="content">
      <div class="row">
        <div class="col-md-9 content">
          <nav class="crumbs">
            <ol class="breadcrumb">
              
              
              
              <li><a href="../../../">Introduction</a></li>
              
              
              
              
              
              <li><a href="../../">Topics</a></li>
              
              
              
              
              
              <li><a href="../">Security</a></li>
              
              
              
              
              
              <li class="active">SSL</li>
              
              
              
            </ol>
          </nav>
          <h1 id="ssl">SSL<a class="anchor" href="#ssl" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h1>

<p>This is a guide to setting up SSL using the C/C++ driver. This guide will use self-signed certificates, but most steps will be similar for certficates generated by a certificate authority (CA). The first step is to generate a public and private key pair for all Cassandra nodes and configure them to use the generated certificate.</p>

<p>Some notes on this guide:
- Keystore and truststore might be used interchangably. These can and often times are the same file. This guide uses the same file for both (keystore.jks) The difference is keystores generally hold private keys and truststores hold public keys/certificate chains.
- Angle bracket fields (e.g. <code>&lt;field&gt;</code>) in examples need to be replaced with values specific to your environment.
- <a href="https://docs.oracle.com/javase/6/docs/technotes/tools/solaris/keytool.html">keytool</a> is an application included with Java 6+</p>

<p>SSL can be rather cumbersome to setup; if assistance is required please use the <a href="https://groups.google.com/a/lists.datastax.com/forum/#!forum/cpp-driver-user">mailing list</a> or <a href="http://webchat.freenode.net/?channels=datastax-drivers">#datastax-drivers on <code>irc.freenode.net &lt;http://freenode.net&gt;</code></a> for help.</p>

<h3 id="generating-the-cassandra-public-and-private-keys">Generating the Cassandra Public and Private Keys<a class="anchor" href="#generating-the-cassandra-public-and-private-keys" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h3>

<p>The most secure method of setting up SSL is to verify that DNS or IP address used to connect to the server matches identity information found in the SSL certificate. This helps to prevent man-in-the-middle attacks. Cassandra uses IP addresses internally so that’s the only supported information for identity verification. That means that the IP address of the Cassandra server where the certficate is installed needs to be present in either the certficate’s common name (CN) or one of its subject alternative names (SANs). It’s possible to create the certficate without either, but then it will not be possible to verify the server’s identity. Although this is not as secure, it eases the deployment of SSL by allowing the same certficate to be deployed across the entire Cassandra cluster.</p>

<p>To generate a public/private key pair with the IP address in the CN field use the following:</p>
<pre class="highlight"><code class="bash">keytool -genkeypair -noprompt -keyalg RSA -validity 36500 <span class="se">\</span>
  -alias node <span class="se">\</span>
  -keystore keystore.jks <span class="se">\</span>
  -storepass &lt;keystore password&gt; <span class="se">\</span>
  -keypass &lt;key password&gt; <span class="se">\</span>
  -dname <span class="s2">"CN=&lt;IP address goes here&gt;, OU=Drivers and Tools, O=DataStax Inc., L=Santa Clara, ST=California, C=US"</span>
</code></pre>
<p>If SAN is prefered use this command:</p>
<pre class="highlight"><code class="bash">keytool -genkeypair -noprompt -keyalg RSA -validity 36500 <span class="se">\</span>
  -alias node <span class="se">\</span>
  -keystore keystore.jks <span class="se">\</span>
  -storepass &lt;keystore password&gt; <span class="se">\</span>
  -keypass &lt;key password&gt; <span class="se">\</span>
  -ext <span class="nv">SAN</span><span class="o">=</span><span class="s2">"&lt;IP address goes here&gt;"</span> <span class="se">\</span>
  -dname <span class="s2">"CN=node1.datastax.com, OU=Drivers and Tools, O=DataStax Inc., L=Santa Clara, ST=California, C=US"</span>
</code></pre>
<p><strong>NOTE:</strong> If an IP address SAN is present then it overrides checking the CN.</p>

<h3 id="enabling-client-to-node-encryption-on-cassandra">Enabling <code>client-to-node</code> Encryption on Cassandra<a class="anchor" href="#enabling-client-to-node-encryption-on-cassandra" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h3>

<p>The generated keystore from the previous step will need to be copied to all Cassandra node(s) and an update of the cassandra.yaml configuration file will need to be performed.</p>
<pre class="highlight"><code class="bash">client_encryption_options:
  enabled: <span class="nb">true
  </span>keystore: &lt;Path to keystore&gt;/keystore.jks
  keystore_password: &lt;keystore password&gt; <span class="c">## The password used when generating the keystore.</span>
  truststore: &lt;Path to keystore&gt;/keystore.jks
  truststore_password: &lt;keystore password&gt;
  require_client_auth: &lt;<span class="nb">true </span>or <span class="nb">false</span>&gt;
</code></pre>
<p><strong>NOTE:</strong> In this example keystore and truststore are identical.</p>

<p>The following <a href="http://www.datastax.com/documentation/cassandra/2.1/cassandra/security/secureSSLClientToNode_t.html">guide</a> has more information related to configuring SSL on Cassandra.</p>

<h2 id="setting-up-the-c-c-driver-to-use-ssl">Setting up the C/C++ Driver to Use SSL<a class="anchor" href="#setting-up-the-c-c-driver-to-use-ssl" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h2>

<p>A <a href="http://datastax.github.io/cpp-driver/api/struct_cass_ssl/"><code>CassSsl</code></a> object is required and must be configured:</p>
<pre class="highlight"><code class="c"><span class="cp">#include &lt;cassandra.h&gt;
</span>
<span class="kt">void</span> <span class="nf">setup_ssl</span><span class="p">(</span><span class="nc">CassCluster</span><span class="o">*</span> <span class="n">cluster</span><span class="p">)</span> <span class="p">{</span>
  <span class="nc">CassSsl</span><span class="o">*</span> <span class="n">ssl</span> <span class="o">=</span> <span class="nb">cass_ssl_new</span><span class="p">();</span>

  <span class="c1">// Configure SSL object...
</span>
  <span class="c1">// To enable SSL attach it to the cluster object
</span>  <span class="nb">cass_cluster_set_ssl</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">ssl</span><span class="p">);</span>

  <span class="c1">// You can detach your reference to this object once it's
</span>  <span class="c1">// added to the cluster object
</span>  <span class="nb">cass_ssl_free</span><span class="p">(</span><span class="n">ssl</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
<h4 id="exporting-and-loading-the-cassandra-public-key">Exporting and Loading the Cassandra Public Key<a class="anchor" href="#exporting-and-loading-the-cassandra-public-key" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h4>

<p>The default setting of the driver is to verify the certifcate sent during the SSL handshake. For the driver to properly verify the Cassandra certifcate the driver needs either the public key from the self-signed public key or the CA certificate chain used to sign the public key. To have this work, extract the public key from the Cassandra keystore generated in the previous steps. This exports a <a href="https://www.openssl.org/docs/crypto/pem.html#PEM_ENCRYPTION_FORMAT">PEM formatted</a> certficate which is required by the C/C++ driver. </p>
<pre class="highlight"><code class="bash">keytool -exportcert -rfc -noprompt <span class="se">\</span>
  -alias node <span class="se">\</span>
  -keystore keystore.jks <span class="se">\</span>
  -storepass &lt;keystore password&gt; <span class="se">\</span>
  -file cassandra.pem
</code></pre>
<p>The trusted certficate can then be loaded using the following code:
“`c
int load_trusted_cert_file(const char* file, CassSsl* ssl) {
  CassError rc;
  char* cert;
  long cert_size;</p>

<p>FILE *in = fopen(file, &#8220;rb”);
  if (in == NULL) {
    fprintf(stderr, “Error loading certificate file ’%s’\n”, file);
    return 0;
  }</p>

<p>fseek(in, 0, SEEK_END);
  cert_size = ftell(in);
  rewind(in);</p>

<p>cert = (char*)malloc(cert_size);
  fread(cert, sizeof(char), cert_size, in);
  fclose(in);</p>

<p>// Add the trusted certificate (or chain) to the driver
  rc = cass_ssl_add_trusted_cert(ssl, cass_string_init2(cert, cert_size));
  if (rc != CASS_OK) {
    fprintf(stderr, “Error loading SSL certificate: %s\n”, cass_error_desc(rc));
    free(cert);
    return 0;
  }</p>

<p>free(cert);
  return 1;
}
“`</p>

<p>It is possible to load multiple self-signed certificates or CA certficate chains. In the event where self-signed certfiicates with unique IP addresses are being used this will be required. It is possible to disable the certificate verification process, but it is not recommended.</p>
<pre class="highlight"><code class="c"><span class="c1">// Disable certifcate verifcation
</span><span class="nb">cass_ssl_set_verify_flags</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="n">CASS_SSL_VERIFY_NONE</span><span class="p">);</span>
</code></pre>
<h4 id="enabling-cassandra-identity-verification">Enabling Cassandra identity verification<a class="anchor" href="#enabling-cassandra-identity-verification" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h4>

<p>If a unique certifcate has been generated for each Cassandra node with the IP address in the CN or SAN fields, identity verification will also need to be enabled.</p>

<p><strong>NOTE:</strong> This is disabled by default.</p>
<pre class="highlight"><code class="c"><span class="c1">// Add identity verification flag: CASS_SSL_VERIFY_PEER_IDENTITY
</span><span class="nb">cass_ssl_set_verify_flags</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="n">CASS_SSL_VERIFY_PEER_CERT</span> <span class="o">|</span> <span class="n">CASS_SSL_VERIFY_PEER_IDENTITY</span><span class="p">);</span>
</code></pre>
<h3 id="using-cassandra-and-the-c-c-driver-with-client-side-certifcates">Using Cassandra and the C/C++ driver with client-side certifcates<a class="anchor" href="#using-cassandra-and-the-c-c-driver-with-client-side-certifcates" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h3>

<p>Client-side certificates allow Cassandra to authenticate the client using public key cryptography and chains of trust. This is same process as above but in reverse. The client has a public and private key and the Cassandra node has a copy of the private key or the CA chain used to generate the pair.</p>

<h4 id="genterating-and-loading-the-client-side-certficate">Genterating and loading the client-side certficate<a class="anchor" href="#genterating-and-loading-the-client-side-certficate" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h4>

<p>A new public/private key pair needs to be generated for client authentication.</p>
<pre class="highlight"><code class="bash">keytool -genkeypair -noprompt -keyalg RSA -validity 36500 <span class="se">\</span>
  -alias driver <span class="se">\</span>
  -keystore keystore-driver.jks <span class="se">\</span>
  -storepass &lt;keystore password&gt; <span class="se">\</span>
  -keypass &lt;key password&gt;
</code></pre>
<p>The public and private key then need to be extracted and converted to the PEM format.</p>

<p>To extract the public:</p>
<pre class="highlight"><code class="bash">keytool -exportcert -rfc -noprompt <span class="se">\</span>
  -alias driver <span class="se">\</span>
  -keystore keystore-driver.jks <span class="se">\</span>
  -storepass &lt;keystore password&gt; <span class="se">\</span>
  -file driver.pem
</code></pre>
<p>To extract and convert the private key:</p>
<pre class="highlight"><code class="bash">keytool -importkeystore -noprompt -srcalias certificatekey -deststoretype PKCS12 <span class="se">\</span>
  -srcalias driver <span class="se">\</span>
  -srckeystore keystore-driver.jks <span class="se">\</span>
  -srcstorepass &lt;keystore password&gt; <span class="se">\</span>
  -storepass &lt;key password&gt; <span class="se">\</span>
  -destkeystore keystore-driver.p12

openssl pkcs12 -nomacver -nocerts <span class="se">\</span>
  -in keystore-driver.p12 <span class="se">\</span>
  -password pass:&lt;key password&gt; <span class="se">\</span>
  -passout pass:&lt;key password&gt; <span class="se">\</span>
  -out driver-private.pem
</code></pre>
<p>Now PEM formatted public and private key can be loaded. These files can be loaded using the same code from above in load_trusted_cert_file().</p>
<pre class="highlight"><code class="c"><span class="nc">CassError</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">CASS_OK</span><span class="p">;</span>

<span class="kt">char</span><span class="o">*</span> <span class="n">cert</span> <span class="o">=</span> <span class="nx">NULL</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">cert_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// Load PEM-formatted certificate data and size into cert and cert_size...
</span>
<span class="n">rc</span> <span class="o">=</span> <span class="nb">cass_ssl_set_cert</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="nb">cass_string_init2</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">cert_size</span><span class="p">));</span>
<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">CASS_OK</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Handle error
</span><span class="p">}</span>

<span class="kt">char</span><span class="o">*</span> <span class="n">key</span> <span class="o">=</span> <span class="nx">NULL</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">key_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// A password is required when the private key is encrypted. If the private key
// is NOT password protected use NULL.
</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">key_password</span> <span class="o">=</span> <span class="s">"&lt;key password&gt;"</span><span class="p">;</span>

<span class="c1">// Load PEM-formatted private key data and size into key and key_size...
</span>
<span class="n">rc</span> <span class="o">=</span> <span class="nb">cass_ssl_set_private_key</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="nb">cass_string_init2</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key_size</span><span class="p">),</span> <span class="n">key_password</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">CASS_OK</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Handle error
</span><span class="p">}</span>
</code></pre>
<h4 id="setting-up-client-authentication-with-cassandra">Setting up client authentication with Cassandra<a class="anchor" href="#setting-up-client-authentication-with-cassandra" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h4>

<p>The driver’s public key or the CA chain used to sign the driver’s certificate will need to be added to Cassandra’s truststore. If using self-signed certificate then the public key will need to be extrated from the driver’s keystore generated in the previous steps.</p>

<p>Extract the public key from the driver’s keystore and add it to Cassandra’s truststore.</p>
<pre class="highlight"><code class="bash">keytool -exportcert -noprompt <span class="se">\</span>
  -alias driver <span class="se">\</span>
  -keystore keystore-driver.jks <span class="se">\</span>
  -storepass cassandra <span class="se">\</span>
  -file cassandra-driver.crt

keytool -import -noprompt <span class="se">\</span>
  -alias truststore <span class="se">\</span>
  -keystore keystore.jks <span class="se">\</span>
  -storepass cassandra <span class="se">\</span>
  -file cassandra-driver.crt
</code></pre>
<p>Client authentication in cassandra.yaml will also need to be enabled</p>
<pre class="highlight"><code class="yaml"><span class="s">require_client_auth</span><span class="pi">:</span> <span class="s">true</span>
</code></pre>
        </div>
        <nav class="col-md-3 side-nav">
          <ol class="nav nav-pills nav-stacked toc" data-spy="affix" data-offset-top="60" data-offset-bottom="25">
            
              
                
                  <li><a href="../../building/">Building</a></li>
                
              
                
                  <li><a href="../../basics/">Basics</a></li>
                
              
                
                  <li class="active">
                    <a href="../">Security</a>
                    <ul class="nav nav-pills nav-stacked">
                      
                      
                      <li><a href="../authentication/">Authentication</a></li>
                      
                      
                      
                      <li class="active">
                        <a href="./">SSL</a>
                        <ul class="nav nav-pills nav-stacked">
<li><a href="#setting-up-the-c-c-driver-to-use-ssl">Setting up the C/C++ Driver to Use SSL
</a></li>
<li><a href="#generating-the-cassandra-public-and-private-keys">Generating the Cassandra Public and Private Keys
</a></li>
<li><a href="#enabling-client-to-node-encryption-on-cassandra">Enabling client-to-node Encryption on Cassandra
</a></li>
<li><a href="#using-cassandra-and-the-c-c-driver-with-client-side-certifcates">Using Cassandra and the C/C++ driver with client-side certifcates
</a></li>
</ul>
                      </li>
                      
                      
                    </ul>
                  </li>
                
              
                
                  <li><a href="../../logging/">Logging</a></li>
                
              
                
                  <li><a href="../../faq/">FAQ</a></li>
                
              
                
                  <li><a href="../../configuration/">Configuration</a></li>
                
              
                
                  <li><a href="../../testing/">Testing</a></li>
                
              
            
          </ol>
        </nav>
      </div>
    </div>

    <footer class="container text-muted">
      <ul class="list-inline">
        <li>
          <a href="https://github.com/datastax/cpp-driver">Code</a>
        </li>
        <li>·</li>
        <li>
          <a href="http://datastax.github.io/cpp-driver/">Docs</a>
        </li>
        <li>·</li>
        <li>
          <a href="https://datastax-oss.atlassian.net/browse/CPP">Issues</a>
        </li>
        <li>·</li>
        <li>
          <a href="https://groups.google.com/a/lists.datastax.com/forum/#!forum/cpp-driver-user">Mailing List</a>
        </li>
        <li>·</li>
        <li>
          <a href="irc://irc.freenode.net/datastax-drivers">IRC Channel</a>
        </li>
        <li>·</li>
        <li>
          <a href="https://github.com/datastax/cpp-driver/releases">Releases</a>
        </li>
      </ul>
    </footer>

    <script src="../../../js/jquery.js"></script>
    <script src="../../../js/bootstrap.js"></script>
    <script src="../../../js/angular.js"></script>
    <script src="../../../js/mousetrap.js"></script>
    <script src="../../../js/hotkeys.js"></script>
    <script src="../../../js/ZeroClipboard.js"></script>
    <script src="../../../js/lunr.js"></script>
    <script src="../../../js/app.js"></script>
  </body>
</html>
